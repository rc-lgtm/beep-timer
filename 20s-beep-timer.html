<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Timer</title>
  <style>
    :root{
      --blue:#2563eb;
      --green:#16a34a;
      --red:#dc2626;
      --black:#0b0b0b;
      --text:#ffffff;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--black);
      color: var(--text);
    }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      transition: background-color .25s ease;
    }
    .card{
      width:min(720px, 95vw);
      text-align:center;
    }
    .display{
      font-size: clamp(48px, 12vw, 120px);
      font-weight: 800;
      letter-spacing: .04em;
      padding: 24px 16px;
      margin-bottom: 16px;
      user-select:none;
    }
    .status{
      margin-top: -8px;
      margin-bottom: 16px;
      font-size: clamp(16px, 3.8vw, 22px);
      opacity:.9;
      min-height: 1.4em;
    }
    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    button{
      font-size:18px;
      font-weight:700;
      padding:12px 18px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      background:#ffffff;
      color:#111;
      box-shadow: 0 4px 14px rgba(0,0,0,.25);
    }
    button:active{ transform: translateY(1px); }
    .opts{
      display:flex;
      gap:16px;
      justify-content:center;
      align-items:center;
      margin-top:14px;
      font-size:14px;
      opacity:.95;
    }
    .hint{
      margin-top:8px;
      font-size:13px;
      opacity:.8;
    }
    .linkish { text-decoration: underline; cursor:default; }
  </style>
</head>
<body>
  <div class="wrap" id="bg">
    <div class="card">
      <div class="display" id="time">Press Start</div>
      <div class="status" id="status"></div>
      <div class="row">
        <button id="start">Start</button>
        <button id="pause">Pause</button>
        <button id="reset">Reset</button>
      </div>
      <div class="opts">
        <label><input type="checkbox" id="enable-sound" checked> Beeps on</label>
        <label><input type="checkbox" id="enable-speech" checked> Speak “Workout done”</label>
      </div>
      <div class="hint">
        Space = Start/Pause • Esc = Reset • Every 20s: beep + color swap (blue/green)
      </div>
    </div>
  </div>

  <script>
  (() => {
    // ---- Settings ----
    const PRE_SECONDS = 5;          // 5-second pre-countdown (red, negative display)
    const MAIN_SECONDS = 10 * 60;   // 10 minutes
    const SHORT_BEEP_MS = 160;
    const LONG_BEEP_MS  = 600;      // long beep at transition from pre -> main

    // Colors
    const COLOR_BLUE = getCSSVar('--blue');
    const COLOR_GREEN = getCSSVar('--green');
    const COLOR_RED = getCSSVar('--red');
    const COLOR_BLACK = getCSSVar('--black');

    // Elements
    const bgEl = document.getElementById('bg');
    const timeEl = document.getElementById('time');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const resetBtn = document.getElementById('reset');
    const soundToggle = document.getElementById('enable-sound');
    const speechToggle = document.getElementById('enable-speech');

    // State
    let phase = 'idle'; // 'idle' | 'pre' | 'main' | 'done'
    let running = false;
    let loopId = null;

    let preRemaining = PRE_SECONDS;
    let mainRemaining = MAIN_SECONDS;

    let prevTick = 0;
    let last20Bucket = Math.floor(MAIN_SECONDS / 20); // sentinel; will get reset on start
    let currentMainColor = COLOR_BLUE;
    let audioCtx = null;

    // ---- UI helpers ----
    function setBG(color) { bgEl.style.backgroundColor = color; }
    function formatMMSS(sec) {
      sec = Math.max(0, Math.ceil(sec)); // display rounds up remaining seconds
      const mm = Math.floor(sec / 60);
      const ss = sec % 60;
      return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    function setDisplayPre(sec) {
      timeEl.textContent = `-${formatMMSS(sec)}`;
    }
    function setDisplayMain(sec) {
      const s = Math.max(0, Math.ceil(sec));
      timeEl.textContent = formatMMSS(s);
    }
    function setStatus(msg='') { statusEl.textContent = msg; }
    function getCSSVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

    // ---- Audio ----
    function ensureAudio() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.warn('WebAudio unavailable', e);
        }
      }
      return audioCtx;
    }
    function beep(ms=SHORT_BEEP_MS, freq=880){
      if (!soundToggle.checked) return;
      const ctx = ensureAudio();
      if (!ctx) return;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      // envelope (avoid clicks)
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.35, now + 0.01);
      gain.gain.setValueAtTime(0.35, now + (ms - 40)/1000);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);

      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now);
      osc.stop(now + ms/1000);
    }
    function speak(text){
      if (!speechToggle.checked) return;
      if (!('speechSynthesis' in window)) return;
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0; u.pitch = 1.0;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {}
    }

    // ---- Controls ----
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); toggleStartPause(); }
      if (e.code === 'Escape') { e.preventDefault(); resetTimer(); }
    });

    function startTimer(){
      if (phase === 'idle' || phase === 'done') {
        preRemaining = PRE_SECONDS;
        mainRemaining = MAIN_SECONDS;
        last20Bucket = Math.floor(mainRemaining / 20); // reset the 20s bucket
        currentMainColor = COLOR_BLUE;

        phase = 'pre';
        setBG(COLOR_RED);
        setDisplayPre(preRemaining);
        setStatus('Get ready…');
      }
      if (!running){
        ensureAudio(); // prime on gesture
        running = true;
        prevTick = performance.now();
        scheduleLoop();
      }
    }

    function pauseTimer(){
      running = false;
      if (loopId) {
        cancelAnimationFrame(loopId);
        loopId = null;
      }
      setStatus('Paused');
    }

    function resetTimer(){
      running = false;
      if (loopId) {
        cancelAnimationFrame(loopId);
        loopId = null;
      }
      phase = 'idle';
      preRemaining = PRE_SECONDS;
      mainRemaining = MAIN_SECONDS;
      last20Bucket = Math.floor(mainRemaining / 20);
      setBG(COLOR_BLACK);
      timeEl.textContent = 'Press Start';
      setStatus('');
    }

    function toggleStartPause(){
      if (running) pauseTimer();
      else startTimer();
    }

    // ---- Main loop (delta-t based, drift-resistant) ----
    function scheduleLoop(){ loopId = requestAnimationFrame(tick); }
    function tick(now){
      if (!running) return;
      const dt = Math.min(0.25, (now - prevTick) / 1000); // cap big frame jumps
      prevTick = now;

      if (phase === 'pre'){
        preRemaining -= dt;
        if (preRemaining > 0){
          setDisplayPre(preRemaining);
        } else {
          // Transition to main
          phase = 'main';
          setBG(currentMainColor = COLOR_BLUE);
          setDisplayMain(mainRemaining);
          setStatus('Go!');
          beep(LONG_BEEP_MS, 880); // long beep exactly when main starts
        }
        scheduleLoop();
        return;
      }

      if (phase === 'main'){
        const prevRemaining = mainRemaining;
        mainRemaining -= dt;

        // Detect crossing 20s boundaries (excluding the very first instant at 10:00)
        const prevBucket = Math.floor(prevRemaining / 20);
        const currBucket = Math.floor(Math.max(0, mainRemaining) / 20);
        if (currBucket !== prevBucket && prevRemaining !== MAIN_SECONDS) {
          // crossed into a new 20s slot
          beep(SHORT_BEEP_MS, 880);
          // toggle color
          currentMainColor = (currentMainColor === COLOR_BLUE) ? COLOR_GREEN : COLOR_BLUE;
          setBG(currentMainColor);
        }

        if (mainRemaining > 0){
          setDisplayMain(mainRemaining);
          scheduleLoop();
        } else {
          // Done
          phase = 'done';
          setBG(COLOR_BLACK);
          timeEl.textContent = 'Workout done!';
          setStatus('');
          beep(SHORT_BEEP_MS, 880);
          speak('Workout done');
        }
        return;
      }

      // done/idle fallthrough
    }
  })();
  </script>
</body>
</html>
